<!doctype html>
<html lang="en">
<head>
    <title>Demographix</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="%description%" />
    <meta name="keywords" content="" />
    <meta name="author" content="ComponentOne" />
    <link type="text/css" href="css/aristo/jquery-ui-1.8.4.custom.css" rel="stylesheet" />
    <link href="css/jquery.wijmo-open.0.8.0.css" rel="stylesheet" type="text/css" />
    <link href="css/jquery.wijmo-complete.0.8.0.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/2.1/js/dojo/dijit/themes/claro/claro.css">
    <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.5.custom.min.js"></script>
    <script type="text/javascript" src="js/jquery.bgiframe-2.1.1.js"></script>
    <script type="text/javascript" src="js/jquery.glob.min.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>
    <script type="text/javascript" src="js/raphael.js"></script>
    <script type="text/javascript" src="js/raphael-popup.js"></script>
    <script src="js/jquery.wijmo-open.0.8.0.min.js" type="text/javascript"></script>
    <script src="js/jquery.wijmo-complete.0.8.0.min.js" type="text/javascript"></script>
    <!-- ArcGIS API for JavaScript -->
    <script type="text/javascript">        var djConfig = { parseOnLoad: true };</script>
    <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=2.1"></script>
    <script type="text/javascript">
        dojo.require("dijit.layout.BorderContainer");
        dojo.require("dijit.layout.ContentPane");
        dojo.require("esri.map");
        dojo.require("esri.utils");
        dojo.require("esri.tasks.query");

        var map, queryTask, query, click;
        var wd = 240;
        var ht = 110;
        var chartParams = { cht: "p3", chl: "White|Black|Hispanic|Asian|Other" };
        var clicks = 0;

        function init() {
            map = new esri.Map("map", {
                slider: false,
                extent: new esri.geometry.Extent({ "xmin": -8276294, "ymin": 4953481, "xmax": -8196571, "ymax": 4999114, "spatialReference": { "wkid": 102100} })
            });

            map.addLayer(new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"));
            map.addLayer(new esri.layers.ArcGISDynamicMapServiceLayer("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer", { opacity: 0.4 }));
            dojo.connect(map, "onClick", doQuery);

            queryTask = new esri.tasks.QueryTask("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/3");
            dojo.connect(queryTask, "onComplete", getChart);

            dojo.connect(map.infoWindow, "onHide", function () { map.graphics.clear(); });
            query = new esri.tasks.Query();
            query.spatialRelationship = esri.tasks.Query.SPATIAL_REL_INTERSECTS;
            query.outFields = ["NAME", "WHITE", "BLACK", "ASIAN", "HISPANIC", "OTHER"];
            query.returnGeometry = true;
            query.outSpatialReference = { "wkid": 102100 };



            dojo.connect(map, "onLoad", function () {
                console.log("Map onLoad event");

                /*****************
                * Hook up jQuery
                *****************/
                $(document).ready(jQueryReady);
            });

            var resizeTimer;
            dojo.connect(map, 'onLoad', function (theMap) {
                dojo.connect(dijit.byId('map'), 'resize', function () {  //resize the map if the div is resized
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(function () {
                        map.resize();
                        map.reposition();
                    }, 500);
                });
            });
        }

        function jQueryReady() {
            console.log("jQuery ready event");

            $("#tipper").wijtooltip({ showCallOut: false }).wijtooltip("show");

            $("#jqSlider").wijslider({
                min: 0,
                max: 17,
                value: map.getLevel(),
                orientation: "vertical",

                change: function (event, ui) {
                    map.setLevel(ui.value);
                }
            });
            dojo.connect(map, "onZoomEnd", function (evt) {
                $("#jqSlider").wijslider("value", map.getLevel());
            });
        }

        function doQuery(evt) {
            $("#tipper").wijtooltip("option", "content", "Hardcore mapping action...").wijtooltip("show");
            click = query.geometry = evt.mapPoint;
            queryTask.execute(query);
        }

        function getChart(featureSet) {

            var duration = 500;
            var radiusOffset = 18;
            var offset = {};
            map.graphics.clear();
            var features = featureSet.features;
            var feature, attributes, white, black, asian, hispanic, other, total, graphic;
            for (var i = 0; i < features.length; i++) {
                feature = features[i];
                attributes = feature.attributes;

                if (clicks > 0) {
                    $("#chart").html("").wijpiechart("destroy");
                }
                $("#chart").wijpiechart({
                    radius: 140,
                    legend: { visible: true },
                    hint: {
                        formatter: function () {
                            return this.data.label + " : " + $.format(this.value / this.total, "p2");
                        }
                    },
                    header: {
                        text: attributes["NAME"] + " County Demographics"
                    },
                    seriesList: [{
                        label: "White",
                        data: parseInt(attributes.WHITE)
                    }, {
                        label: "Black",
                        data: parseInt(attributes.BLACK)
                    }, {
                        label: "Asian",
                        data: parseInt(attributes.ASIAN)
                    }, {
                        label: "Hispanic",
                        data: parseInt(attributes.HISPANIC)
                    }, {
                        label: "Other",
                        data: parseInt(attributes.OTHER)
                    }]
                });

                if (clicks == 0) {
                    $("#chart").bind("wijpiechartmouseover", function (e, objData) {
                        if (objData != null) {

                            var series = objData;
                            var sector = $("#chart").wijpiechart("getSector", series.index);
                            var shadow = sector.shadow;

                            offset = sector.getOffset(radiusOffset);

                            sector.animate({
                                translation: offset.x + " " + offset.y
                            }, duration, "elastic");

                            if (shadow) {
                                shadow.animate({
                                    translation: offset.x + " " + offset.y
                                }, duration, "elastic");
                            }
                        }
                    });

                    $("#chart").bind("wijpiechartmouseout", function (e, objData) {
                        if (objData != null) {
                            var series = objData;
                            var sector = $("#chart").wijpiechart("getSector", series.index);
                            var shadow = sector.shadow;

                            sector.animate({
                                translation: -offset.x + " " + offset.y * -1
                            }, duration, "elastic");

                            if (shadow) {
                                shadow.animate({
                                    translation: -offset.x + " " + offset.y * -1
                                }, duration, "elastic");
                            }

                            offset = { x: 0, y: 0 };
                        }
                    });
                }
                var mySymbol = new esri.symbol.SimpleFillSymbol("none", new esri.symbol.SimpleLineSymbol("dashdot", new dojo.Color([255, 0, 0]), 2.5), new dojo.Color([255, 255, 0, 0.25]));

                feature.setSymbol(mySymbol);
                map.graphics.add(feature);
                clicks = 1;
            }
            $("#tipper").wijtooltip("hide");
        }

        dojo.addOnLoad(init);

        //Display any errors that were caught when attempting to solve the rotue
        function errorHandler(err) {
            alert("An error occured\n" + err.message + "\n" + err.details.join("\n"));
        }

    </script>
    <style type="text/css">
        /*demo page css*/
        
        html, body
        {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #map
        {
            padding: 0;
        }
        #chart
        {
            background: #fff;
            background: rgba(255,255,255,0.5);
        }
        body
        {
            font-size: 12px;
        }
        a img
        {
            border: none;
        }
        .header
        {
            position: absolute;
            top: 10px;
            left: 60px;
            z-index: 98;
            background: #000;
            background: rgba(0,0,0,0.35);
            padding: 5px;
            -moz-border-radius: 3px;
            -webkit-border-radius: 3px;
            border-radius: 3px;
        }
        .header h1
        {
            color: #fff;
            text-shadow: 0px 1px 5px rgba(0,0,0,1);
            font-weight: 800;
            font-size: 3em;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="demo-single">
    <div style="position: absolute; bottom: 10px; left: 10px; z-index: 99">
        <div id="chart" class="ui-widget ui-widget-content ui-corner-all" style="width: 400px; height: 300px;">
        </div>
    </div>
    <div dojotype="dijit.layout.BorderContainer" design="headline" gutters="false" style="width: 100%; height: 100%; margin: 0;">
        <div id="map" dojotype="dijit.layout.ContentPane" region="center" style="overflow: hidden;">
            <div style="position: absolute; left: 20px; top: 20px; z-index: 100;">
                <div id="jqSlider" style="height: 200px">
                </div>
            </div>
        </div>
    </div>
    <div class="ui-widget header">
        <h1>
            Demographix</h1>
    </div>
    <div id="working" style="position: absolute; top: 0; right: 10px; z-index: 99;">
        <a id="tipper" href="#" title="Click the map to see demographics for a county!">&nbsp;</a>
    </div>
</body>
</html>
